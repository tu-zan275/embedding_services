version: "3.9"

services:
  chroma:
    image: chromadb/chroma:latest
    container_name: chroma
    environment:
      IS_PERSISTENT: "TRUE"
      PERSIST_DIRECTORY: /chroma/chroma
    volumes:
      - chroma_data:/chroma/chroma
    networks:
      - chroma_net
    restart: unless-stopped

  chroma_proxy:
    image: nginx:alpine
    container_name: chroma_proxy
    ports:
      - "7985:80"   # ðŸŒ expose ra Internet
    depends_on:
      - chroma
    environment:
      CHROMA_API_KEY: "YOUR_SECRET_API_KEY"
    networks:
      - chroma_net
    restart: unless-stopped
    command: >
      sh -c "
      cat << 'EOF' > /etc/nginx/nginx.conf
      events {}

      http {
        map \$http_x_api_key \$authorized {
          default 0;
          ${CHROMA_API_KEY} 1;
        }

        server {
          listen 80;

          location / {
            if (\$authorized = 0) {
              return 401;
            }

            proxy_pass http://chroma:8000;
            proxy_http_version 1.1;
            proxy_set_header Host \$host;
            proxy_set_header X-Real-IP \$remote_addr;
            proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
          }
        }
      }
      EOF
      && nginx -g 'daemon off;'
      "

volumes:
  chroma_data:

networks:
  chroma_net:
    driver: bridge
